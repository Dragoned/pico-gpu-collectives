TASKS_PER_NODE ?= 1

CFLAGS = $(CFLAGS_COMMON) -DGPU_ON_NODE=$(TASKS_PER_NODE)
NVCC ?= nvcc

NVCCFLAGS := -O3 -Xcompiler "-fPIC" -I$(PICO_DIR)/include -I.

NVCCFLAGS += -Xcompiler "-MMD -MP"

# Aggiunge i flag condizionali (DEBUG, INSTRUMENT) a NVCC
ifeq ($(DEBUG),1)
    NVCCFLAGS += -DDEBUG -g
endif
ifeq ($(PICO_INSTRUMENT),1)
    NVCCFLAGS += -DPICO_INSTRUMENT
endif

CFLAGS_CUDA =
ifeq ($(GPU_NATIV_SUPPORT),1)
    CFLAGS_CUDA += -DGPU_NATIV_SUPPORT
    NVCCFLAGS += -DGPU_NATIV_SUPPORT
endif
ifeq ($(PICO_MPI_CUDA_AWARE),1)
    CFLAGS_CUDA += -DPICO_MPI_CUDA_AWARE
    NVCCFLAGS += -DPICO_MPI_CUDA_AWARE
endif


LIB_DIR ?= ../lib

LIB_SRC := $(wildcard *.c)
LIB_OBJ_DIR ?= ../obj/lib
LIB_OBJS := $(patsubst %.c,$(LIB_OBJ_DIR)/%.o,$(LIB_SRC))
LIB_DEPS := $(patsubst %.o,%.d,$(LIB_OBJS))
LIBPICO := $(LIB_DIR)/libpico.a

PICO_CORE_OBJ_DIR_CUDA ?= ../obj/lib_cuda
LIBPICO_CUDA := $(LIB_DIR)/libpico_cuda.a

LIB_SRC_C_FILES_CUDA := $(wildcard *.c)
LIB_SRC_CU_FILES_CUDA := $(wildcard *.cu)

LIB_OBJS_C_CUDA := $(patsubst %.c,$(PICO_CORE_OBJ_DIR_CUDA)/%.o,$(LIB_SRC_C_FILES_CUDA))
LIB_DEPS_C_CUDA := $(patsubst %.o,%.d,$(LIB_OBJS_C_CUDA))

LIB_OBJS_CU_CUDA := $(patsubst %.cu,$(PICO_CORE_OBJ_DIR_CUDA)/%.o,$(LIB_SRC_CU_FILES_CUDA))
LIB_DEPS_CU_CUDA := $(patsubst %.o,%.d,$(LIB_OBJS_CU_CUDA))

LIB_OBJS_CUDA := $(LIB_OBJS_C_CUDA) $(LIB_OBJS_CU_CUDA)
LIB_DEPS_CUDA := $(LIB_DEPS_C_CUDA) $(LIB_DEPS_CU_CUDA)


ifeq ($(PICO_MPI_CUDA_AWARE),1)
all: $(LIBPICO) $(LIBPICO_CUDA)
else
all: $(LIBPICO)
endif

######################################################################
######################STANDARD MAKEFILE TARGETS#######################
######################################################################
$(LIBPICO): $(LIB_OBJS)
	@mkdir -p $(LIB_DIR)
	@echo "[AR] Creating standard library $@"
	ar rcs $@ $^

$(LIB_OBJ_DIR)/%.o: %.c
	@mkdir -p $(LIB_OBJ_DIR)
	$(PICOCC) $(CFLAGS) -c $< -o $@


######################################################################
######################CUDA-AWARE MAKEFILE TARGETS#####################
######################################################################
$(LIBPICO_CUDA): $(LIB_OBJS_CUDA)
	@mkdir -p $(LIB_DIR)
	@echo "[AR] Creating CUDA library $@"
	ar rcs $@ $^

# Regola per file .c (compilati con PICOCC)
$(PICO_CORE_OBJ_DIR_CUDA)/%.o: %.c
	@mkdir -p $(PICO_CORE_OBJ_DIR_CUDA)
	$(PICOCC) $(CFLAGS) $(CFLAGS_CUDA) -c $< -o $@

# Regola per file .cu (compilati con NVCC)
$(PICO_CORE_OBJ_DIR_CUDA)/%.o: %.cu
	@mkdir -p $(PICO_CORE_OBJ_DIR_CUDA)
	$(NVCC) $(NVCCFLAGS) -c $< -o $@

-include $(LIB_DEPS)
-include $(LIB_DEPS_CUDA)

clean:
	@echo -e "[CLEAN] Removing object files and library..."
	@rm -rf $(LIB_OBJ_DIR) $(PICO_CORE_OBJ_DIR_CUDA) $(LIBPICO) $(LIBPICO_CUDA)